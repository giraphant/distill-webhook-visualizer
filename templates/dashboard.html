{% extends "base.html" %}

{% block title %}Dashboard - Distill Webhook Visualiser{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Dashboard Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h2">
                    <i class="fas fa-tachometer-alt me-2"></i>
                    Monitoring Dashboard
                </h1>
                <div>
                    <div class="btn-group me-2" role="group">
                        <input type="radio" class="btn-check" name="timeRange" id="range-1d" value="1" checked>
                        <label class="btn btn-outline-primary" for="range-1d">1D</label>

                        <input type="radio" class="btn-check" name="timeRange" id="range-7d" value="7">
                        <label class="btn btn-outline-primary" for="range-7d">7D</label>

                        <input type="radio" class="btn-check" name="timeRange" id="range-30d" value="30">
                        <label class="btn btn-outline-primary" for="range-30d">30D</label>
                    </div>
                    <button class="btn btn-primary" onclick="refreshDashboard()">
                        <i class="fas fa-sync-alt me-1"></i>
                        Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-eye me-2"></i>
                        Monitors
                    </h6>
                    <button class="btn btn-sm btn-outline-secondary" onclick="refreshMonitors()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-body p-0">
                    <div id="monitors-list">
                        <div class="text-center p-3">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p class="mt-2 small text-muted">Loading monitors...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-tools me-2"></i>
                        Quick Actions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="showComparisonModal()">
                            <i class="fas fa-balance-scale me-2"></i>
                            Compare Monitors
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="exportData()">
                            <i class="fas fa-download me-2"></i>
                            Export Data
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="testWebhook()">
                            <i class="fas fa-vial me-2"></i>
                            Test Webhook
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Chart Area -->
        <div class="col-md-9">
            <div id="charts-container">
                <div class="card">
                    <div class="card-body text-center p-5">
                        <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">Select a monitor to view its chart</h4>
                        <p class="text-muted">Choose a monitor from the sidebar to display its visualization</p>
                    </div>
                </div>
            </div>

            <!-- Selected Monitor Info -->
            <div class="row mt-4" id="monitor-info" style="display: none;">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                Monitor Details
                            </h5>
                        </div>
                        <div class="card-body" id="monitor-details">
                            <!-- Monitor details will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Comparison Modal -->
<div class="modal fade" id="comparisonModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-balance-scale me-2"></i>
                    Compare Monitors
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="comparison-monitors" class="form-label">Select monitors to compare:</label>
                    <div id="comparison-monitors" class="row">
                        <!-- Monitor checkboxes will be populated here -->
                    </div>
                </div>
                <div class="mb-3">
                    <label for="comparison-days" class="form-label">Time range (days):</label>
                    <select class="form-select" id="comparison-days">
                        <option value="1">1 day</option>
                        <option value="7" selected>7 days</option>
                        <option value="30">30 days</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="generateComparison()">
                    <i class="fas fa-chart-line me-1"></i>
                    Generate Comparison
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentMonitors = [];
let selectedMonitorId = null;

// Load dashboard data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadMonitors();

    // Add event listeners for time range buttons
    document.querySelectorAll('input[name="timeRange"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (selectedMonitorId) {
                loadMonitorChart(selectedMonitorId);
            }
        });
    });
});

async function loadMonitors() {
    try {
        const response = await fetch('/api/monitors');
        const monitors = await response.json();
        currentMonitors = monitors;

        const monitorsList = document.getElementById('monitors-list');

        if (monitors.length === 0) {
            monitorsList.innerHTML = `
                <div class="text-center p-3">
                    <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                    <p class="small text-muted">No monitors found</p>
                    <button class="btn btn-sm btn-primary" onclick="testWebhook()">
                        <i class="fas fa-plus me-1"></i>
                        Create Test Data
                    </button>
                </div>
            `;
            return;
        }

        let monitorsHtml = '<div class="list-group list-group-flush">';
        monitors.forEach(monitor => {
            const lastUpdate = new Date(monitor.latest_timestamp).toLocaleDateString();
            const statusIcon = monitor.latest_value !== null ?
                '<i class="fas fa-check-circle text-success"></i>' :
                '<i class="fas fa-question-circle text-warning"></i>';

            monitorsHtml += `
                <a href="#" class="list-group-item list-group-item-action monitor-link" data-monitor-id="${monitor.monitor_id}" onclick="selectMonitor('${monitor.monitor_id}')">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            ${statusIcon}
                            <span class="ms-2">${monitor.monitor_name || monitor.monitor_id}</span>
                        </div>
                        <small class="text-muted">${monitor.total_records}</small>
                    </div>
                    <small class="text-muted d-block mt-1">Last: ${lastUpdate}</small>
                </a>
            `;
        });
        monitorsHtml += '</div>';

        monitorsList.innerHTML = monitorsHtml;

    } catch (error) {
        console.error('Error loading monitors:', error);
        document.getElementById('monitors-list').innerHTML = `
            <div class="alert alert-warning p-2">
                <i class="fas fa-exclamation-triangle"></i>
                <small>Error loading monitors</small>
            </div>
        `;
    }
}

async function selectMonitor(monitorId) {
    selectedMonitorId = monitorId;

    // Update active state
    document.querySelectorAll('.monitor-link').forEach(link => {
        link.classList.remove('active');
    });
    document.querySelector(`[data-monitor-id="${monitorId}"]`).classList.add('active');

    // Load chart and details
    await loadMonitorChart(monitorId);
    await loadMonitorDetails(monitorId);
}

async function loadMonitorChart(monitorId) {
    const timeRange = document.querySelector('input[name="timeRange"]:checked').value;

    // Show loading state
    document.getElementById('charts-container').innerHTML = `
        <div class="card">
            <div class="card-body text-center p-4">
                <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                <p class="mt-2">Generating chart...</p>
            </div>
        </div>
    `;

    try {
        const response = await fetch(`/api/chart-data/${monitorId}?days=${timeRange}`);
        const data = await response.json();

        if (data && data.data && data.data.length > 0) {
            createChart(data);
        } else {
            document.getElementById('charts-container').innerHTML = `
                <div class="card">
                    <div class="card-body text-center p-4">
                        <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No data available</h5>
                        <p class="text-muted">This monitor has no data for the selected time range.</p>
                        <button class="btn btn-primary" onclick="testWebhook()">
                            <i class="fas fa-plus me-1"></i>
                            Generate Test Data
                        </button>
                    </div>
                </div>
            `;
        }

    } catch (error) {
        console.error('Error loading chart:', error);
        document.getElementById('charts-container').innerHTML = `
            <div class="card">
                <div class="card-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Unable to load chart for this monitor. Please try again.
                    </div>
                </div>
            </div>
        `;
    }
}

function createChart(data) {
    const timestamps = data.data.map(d => new Date(d.timestamp));
    const values = data.data.map(d => d.value);
    const changes = data.data.map(d => d.is_change);

    const chartHtml = `
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    ${data.monitor_name || data.monitor_id}
                </h5>
            </div>
            <div class="card-body">
                <canvas id="monitorChart" width="400" height="200"></canvas>
                <div class="row mt-3">
                    <div class="col-md-3">
                        <div class="text-center">
                            <h6 class="text-muted">Total Points</h6>
                            <h4>${data.summary.total_points}</h4>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h6 class="text-muted">Latest Value</h6>
                            <h4>${data.summary.latest_value || 'N/A'}</h4>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h6 class="text-muted">Changes</h6>
                            <h4>${data.summary.changes_detected}</h4>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h6 class="text-muted">Average</h6>
                            <h4>${data.summary.value_range?.avg ? data.summary.value_range.avg.toFixed(2) : 'N/A'}</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    document.getElementById('charts-container').innerHTML = chartHtml;

    // Create Chart.js chart
    const ctx = document.getElementById('monitorChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: timestamps.map(t => t.toLocaleString()),
            datasets: [{
                label: 'Value',
                data: values,
                borderColor: 'rgb(46, 134, 193)',
                backgroundColor: 'rgba(46, 134, 193, 0.1)',
                pointBackgroundColor: changes.map(c => c ? 'rgb(231, 76, 60)' : 'rgb(46, 134, 193)'),
                pointRadius: changes.map(c => c ? 6 : 3),
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: false
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

async function loadMonitorDetails(monitorId) {
    try {
        const monitor = currentMonitors.find(m => m.monitor_id === monitorId);
        if (!monitor) return;

        const detailsHtml = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Monitor Information</h6>
                    <ul class="list-unstyled">
                        <li><strong>ID:</strong> ${monitor.monitor_id}</li>
                        <li><strong>Name:</strong> ${monitor.monitor_name || 'N/A'}</li>
                        <li><strong>URL:</strong> <a href="${monitor.url}" target="_blank">${monitor.url}</a></li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6>Statistics</h6>
                    <ul class="list-unstyled">
                        <li><strong>Total Records:</strong> ${formatNumber(monitor.total_records)}</li>
                        <li><strong>Changes Detected:</strong> ${formatNumber(monitor.change_count)}</li>
                        <li><strong>Latest Value:</strong> ${monitor.latest_value !== null ? monitor.latest_value : 'N/A'}</li>
                        <li><strong>Last Update:</strong> ${formatTimestamp(monitor.latest_timestamp)}</li>
                    </ul>
                </div>
            </div>
        `;

        document.getElementById('monitor-details').innerHTML = detailsHtml;
        document.getElementById('monitor-info').style.display = 'block';

    } catch (error) {
        console.error('Error loading monitor details:', error);
    }
}

function refreshDashboard() {
    loadMonitors();
    if (selectedMonitorId) {
        loadMonitorChart(selectedMonitorId);
        loadMonitorDetails(selectedMonitorId);
    }
}

function refreshMonitors() {
    loadMonitors();
}

function showComparisonModal() {
    if (currentMonitors.length === 0) {
        alert('No monitors available for comparison');
        return;
    }

    // Populate monitor checkboxes
    const monitorsContainer = document.getElementById('comparison-monitors');
    let monitorsHtml = '';

    currentMonitors.forEach(monitor => {
        monitorsHtml += `
            <div class="col-md-6 mb-2">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="${monitor.monitor_id}" id="compare-${monitor.monitor_id}">
                    <label class="form-check-label" for="compare-${monitor.monitor_id}">
                        ${monitor.monitor_name || monitor.monitor_id}
                    </label>
                </div>
            </div>
        `;
    });

    monitorsContainer.innerHTML = monitorsHtml;

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('comparisonModal'));
    modal.show();
}

function generateComparison() {
    alert('Comparison feature coming soon!');
}

function exportData() {
    if (!selectedMonitorId) {
        alert('Please select a monitor first');
        return;
    }

    const timeRange = document.querySelector('input[name="timeRange"]:checked').value;
    const endDate = new Date().toISOString().split('T')[0];
    const startDate = new Date(Date.now() - timeRange * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

    const exportUrl = `/api/data?monitor_id=${selectedMonitorId}&start_date=${startDate}&end_date=${endDate}&limit=1000`;
    window.open(exportUrl, '_blank');
}

async function testWebhook() {
    try {
        const testData = {
            "monitor_id": "test_dashboard_" + Date.now(),
            "monitor_name": "Dashboard Test Monitor",
            "url": "https://example.com/test",
            "value": Math.round(Math.random() * 100 * 100) / 100,
            "status": "test",
            "timestamp": new Date().toISOString(),
            "is_change": Math.random() > 0.5
        };

        const response = await fetch('/webhook/distill', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(testData),
        });

        const result = await response.json();

        if (response.ok) {
            alert('✅ Test webhook sent successfully!');
            refreshDashboard();
        } else {
            alert('❌ Test failed: ' + result.detail);
        }
    } catch (error) {
        alert('❌ Error: ' + error.message);
    }
}
</script>
{% endblock %}