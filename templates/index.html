{% extends "base.html" %}

{% block title %}Distill Webhook Visualizer - Home{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Hero Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="text-center">
                <h1 class="display-4 mb-3">
                    <i class="fas fa-chart-line text-primary me-3"></i>
                    Distill Webhook Visualizer
                </h1>
                <p class="lead text-muted">
                    Receive, store, and visualize data from Distill Web Monitor webhooks in real-time
                </p>
                <div class="mt-4">
                    <a href="/dashboard" class="btn btn-primary btn-lg me-3">
                        <i class="fas fa-tachometer-alt me-2"></i>
                        View Dashboard
                    </a>
                    <a href="/deploy" class="btn btn-success btn-lg me-3">
                        <i class="fas fa-rocket me-2"></i>
                        Deploy & Manage
                    </a>
                    <a href="/docs" class="btn btn-outline-primary btn-lg" target="_blank">
                        <i class="fas fa-book me-2"></i>
                        API Documentation
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-5">
        <div class="col-md-3 mb-3">
            <div class="card stat-card">
                <div class="card-body text-center">
                    <i class="fas fa-database fa-2x mb-3"></i>
                    <h4 class="card-title" id="total-records">--</h4>
                    <p class="card-text">Total Records</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stat-card">
                <div class="card-body text-center">
                    <i class="fas fa-eye fa-2x mb-3"></i>
                    <h4 class="card-title" id="active-monitors">--</h4>
                    <p class="card-text">Active Monitors</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stat-card">
                <div class="card-body text-center">
                    <i class="fas fa-exchange-alt fa-2x mb-3"></i>
                    <h4 class="card-title" id="recent-changes">--</h4>
                    <p class="card-text">Recent Changes</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stat-card">
                <div class="card-body text-center">
                    <i class="fas fa-clock fa-2x mb-3"></i>
                    <h4 class="card-title" id="last-update">--</h4>
                    <p class="card-text">Last Update</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Features Section -->
    <div class="row mb-5">
        <div class="col-12">
            <h2 class="text-center mb-4">Key Features</h2>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-bolt fa-3x text-primary mb-3"></i>
                    <h5 class="card-title">Real-time Webhooks</h5>
                    <p class="card-text">
                        Receive and process Distill webhook data in real-time with automatic timestamp parsing and validation.
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-chart-area fa-3x text-success mb-3"></i>
                    <h5 class="card-title">Interactive Charts</h5>
                    <p class="card-text">
                        Generate beautiful, interactive time-series charts with change detection and multi-monitor comparisons.
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-rocket fa-3x text-info mb-3"></i>
                    <h5 class="card-title">Easy Deployment</h5>
                    <p class="card-text">
                        Deploy with Docker or locally with simple commands. Includes management interface for monitoring.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Setup Instructions -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-cog me-2"></i>
                        Quick Setup
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>
                                <i class="fas fa-link me-2 text-primary"></i>
                                1. Configure Distill Webhook
                            </h5>
                            <p>Set your webhook URL in Distill to:</p>
                            <div class="alert alert-info">
                                <code id="webhook-url">http://localhost:8000/webhook/distill</code>
                                <button class="btn btn-sm btn-outline-primary ms-2" onclick="copyWebhookUrl()">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h5>
                                <i class="fas fa-play me-2 text-success"></i>
                                2. Start Monitoring
                            </h5>
                            <p>Choose JSON format for webhook payload and start monitoring your websites. Data will appear automatically in the dashboard.</p>
                            <a href="/dashboard" class="btn btn-success">
                                <i class="fas fa-tachometer-alt me-1"></i>
                                Go to Dashboard
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-history me-2"></i>
                        Recent Activity
                    </h4>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshActivity()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div id="recent-activity">
                        <div class="text-center">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p class="mt-2">Loading recent activity...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-tools me-2"></i>
                        Quick Actions
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <button class="btn btn-outline-primary w-100" onclick="testWebhook()">
                                <i class="fas fa-vial me-2"></i>
                                Test Webhook
                            </button>
                        </div>
                        <div class="col-md-3 mb-3">
                            <button class="btn btn-outline-success w-100" onclick="generateSampleData()">
                                <i class="fas fa-database me-2"></i>
                                Generate Sample Data
                            </button>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="/api/data" class="btn btn-outline-info w-100" target="_blank">
                                <i class="fas fa-download me-2"></i>
                                Export Data
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <button class="btn btn-outline-warning w-100" onclick="clearData()">
                                <i class="fas fa-trash me-2"></i>
                                Clear All Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Load statistics on page load
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    loadRecentActivity();
});

async function loadStats() {
    try {
        const response = await fetch('/webhook/status');
        const data = await response.json();

        if (data.status === 'operational') {
            document.getElementById('total-records').textContent = formatNumber(data.statistics.total_records);
            document.getElementById('active-monitors').textContent = formatNumber(data.statistics.unique_monitors);

            if (data.statistics.latest_record) {
                const lastUpdate = new Date(data.statistics.latest_record);
                document.getElementById('last-update').textContent = lastUpdate.toLocaleDateString();
            } else {
                document.getElementById('last-update').textContent = 'Never';
            }
        }
    } catch (error) {
        console.error('Error loading stats:', error);
        ['total-records', 'active-monitors', 'recent-changes', 'last-update'].forEach(id => {
            document.getElementById(id).textContent = '--';
        });
    }
}

async function loadRecentActivity() {
    try {
        const response = await fetch('/api/data?limit=10&order_by=webhook_received_at&order_dir=desc');
        const data = await response.json();

        const activityContainer = document.getElementById('recent-activity');

        if (data.length === 0) {
            activityContainer.innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <p>No recent activity. Set up your Distill webhooks to start receiving data!</p>
                </div>
            `;
            return;
        }

        let activityHtml = '<div class="list-group list-group-flush">';

        data.slice(0, 5).forEach(record => {
            const timestamp = formatTimestamp(record.webhook_received_at);
            const statusIcon = record.is_change ?
                '<i class="fas fa-exclamation-triangle text-warning me-2"></i>' :
                '<i class="fas fa-check-circle text-success me-2"></i>';

            activityHtml += `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        ${statusIcon}
                        <strong>${record.monitor_name || record.monitor_id}</strong>
                        <small class="text-muted ms-2">${record.url}</small>
                    </div>
                    <div class="text-end">
                        <div class="text-muted small">${timestamp}</div>
                        ${record.value !== null ? `<div class="badge bg-primary">${record.value}</div>` : ''}
                    </div>
                </div>
            `;
        });

        activityHtml += '</div>';

        if (data.length > 5) {
            activityHtml += `
                <div class="text-center mt-3">
                    <a href="/dashboard" class="btn btn-outline-primary">
                        View All Activity <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
            `;
        }

        activityContainer.innerHTML = activityHtml;

        // Update recent changes count
        const changesCount = data.filter(record => record.is_change).length;
        document.getElementById('recent-changes').textContent = formatNumber(changesCount);

    } catch (error) {
        console.error('Error loading recent activity:', error);
        document.getElementById('recent-activity').innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Unable to load recent activity. Please check your connection.
            </div>
        `;
    }
}

function refreshActivity() {
    showLoading('recent-activity');
    loadRecentActivity();
    loadStats();
}

function copyWebhookUrl() {
    const webhookUrl = document.getElementById('webhook-url').textContent;

    if (navigator.clipboard) {
        navigator.clipboard.writeText(webhookUrl).then(() => {
            // Show success feedback
            const button = event.target.closest('button');
            const originalContent = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check"></i>';
            button.classList.remove('btn-outline-primary');
            button.classList.add('btn-success');

            setTimeout(() => {
                button.innerHTML = originalContent;
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-primary');
            }, 2000);
        });
    }
}

async function testWebhook() {
    try {
        const testData = {
            "monitor_id": "test_webhook_" + Date.now(),
            "monitor_name": "Test Monitor",
            "url": "https://example.com",
            "value": Math.round(Math.random() * 100 * 100) / 100,
            "status": "test",
            "timestamp": new Date().toISOString(),
            "is_change": true
        };

        const response = await fetch('/webhook/distill', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(testData),
        });

        const result = await response.json();

        if (response.ok) {
            alert('✅ Test webhook sent successfully!');
            refreshActivity();
        } else {
            alert('❌ Test failed: ' + result.detail);
        }
    } catch (error) {
        alert('❌ Error: ' + error.message);
    }
}

async function generateSampleData() {
    try {
        const response = await fetch('/api/generate-sample', {
            method: 'POST'
        });

        const result = await response.json();

        if (response.ok) {
            alert('✅ Sample data generated successfully!');
            refreshActivity();
        } else {
            alert('❌ Error: ' + result.detail);
        }
    } catch (error) {
        alert('❌ Error: ' + error.message);
    }
}

async function clearData() {
    if (confirm('Are you sure you want to clear all monitoring data? This action cannot be undone.')) {
        try {
            const response = await fetch('/api/clear-all', {
                method: 'DELETE'
            });

            const result = await response.json();

            if (response.ok) {
                alert('✅ All data cleared successfully!');
                refreshActivity();
            } else {
                alert('❌ Error: ' + result.detail);
            }
        } catch (error) {
            alert('❌ Error: ' + error.message);
        }
    }
}

// Update webhook URL based on current location
document.addEventListener('DOMContentLoaded', function() {
    const webhookUrlElement = document.getElementById('webhook-url');
    const currentUrl = window.location.origin;
    webhookUrlElement.textContent = `${currentUrl}/webhook/distill`;
});
</script>
{% endblock %}